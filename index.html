<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Color Picker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/colorjoe@4.1.1/css/colorjoe.min.css" />
    <link rel="stylesheet" href="./src/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/colorjoe@4.1.1/dist/colorjoe.min.js"></script>
  </head>

  <body>
    <div class="wrapper">
      <main class="main">
        <div class="color-widget">
          <div class="color-widget__picker"></div>

          <div class="color-widget__info info">
            <div class="info__selected-colors selected-colors">
              <div class="selected-colors__title">Selected Color</div>
              <div class="selected-colors__color-name">#ffffff</div>
              <div class="selected-colors__color"></div>
            </div>
            <div class="info__saved-colors saved-colors">
              <div class="saved-colors__title">
                <span class="mode-switch" title="GET: Click on saved color to set it as selected">
                  ðŸ”º
                </span>
                Saved Colors
              </div>
              <ul class="saved-colors__colors-list">
                <li class="saved-colors__color"></li>
                <li class="saved-colors__color"></li>
                <li class="saved-colors__color"></li>
                <li class="saved-colors__color"></li>
                <li class="saved-colors__color"></li>
              </ul>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      /**
       * @todo Add types to code
       * @todo Add background image from Build folder of my phone
       * @todo Add blurry-loading
       * @todo Push to GitHub
       */

      class ColorWidget {
        #isUpdatingMode;

        #modeSwitch;

        #selectedColor;

        #savedColors;

        #colorPicker;

        constructor(widgetElement) {
          // 1. Class state:
          this.#isUpdatingMode = false;

          this.#modeSwitch = widgetElement.savedColors.modeSwitch;
          this.#selectedColor = {
            colorNameDisplay: widgetElement.selectedColor.name,
            colorBar: widgetElement.selectedColor.colorBar,
            lastPicked: '#3aebca',
          };
          this.#savedColors = new Map();
          this.#colorPicker = colorjoe.rgb(widgetElement.colorPicker);

          // 2. Init with basic values:
          this.#setSelectedColorTo('#3aebca');
          this.#setSavedColorsOf(widgetElement.savedColors.colorBars);
          this.#colorPicker.show();

          // 3. Event listeners:
          this.#modeSwitch.addEventListener('click', () => {
            this.#isUpdatingMode = !this.#isUpdatingMode;

            if (this.#isUpdatingMode) {
              this.#modeSwitch.textContent = 'ðŸ”»';
              this.#modeSwitch.title =
                'UPDATE: Click on saved color to replace it with currently selected';
            } else {
              this.#modeSwitch.textContent = 'ðŸ”º';
              this.#modeSwitch.title =
                'GET: Click on saved color to set it as selected';
            }
          });

          this.#selectedColor.colorBar.addEventListener('click', () =>
            this.#setSelectedColorTo(this.#selectedColor.lastPicked),
          );

          this.#colorPicker.on('change', (colorData) => {
            const colorInHex = colorData.hex();

            this.#selectedColor.lastPicked = colorInHex;
            this.#setSelectedColorTo(colorInHex);
          });
        }

        #getInHexValueOf(color) {
          const valueInHex = Number(color).toString(16);

          return valueInHex.length === 1 ? '0' + valueInHex : valueInHex;
        }

        #convertRgbToHex([r, g, b]) {
          return (
            '#' +
            this.#getInHexValueOf(r) +
            this.#getInHexValueOf(g) +
            this.#getInHexValueOf(b)
          );
        }

        // Selected Color:
        #setSelectedColorTo(color) {
          this.#selectedColor.colorNameDisplay.textContent = color;
          this.#selectedColor.colorBar.style.background = color;
        }

        // Saved Color:
        #loadColorsFromCache() {
          const saved = JSON.parse(
            localStorage.getItem('cached-colors') || '[]',
          );

          return new Array(5)
            .fill('#3aebca')
            .map((defaultColor, key) => saved[key] || defaultColor);
        }

        #setSavedColorsOf(colorBars) {
          const currentlySavedColors = this.#loadColorsFromCache();

          colorBars.forEach((colorBar, key) => {
            this.#savedColors.set(colorBar, currentlySavedColors[key]);
            colorBar.style.background = currentlySavedColors[key];

            colorBar.addEventListener('click', () => {
              if (this.#isUpdatingMode) {
                this.#updateSavedColor(colorBar, key);
              } else {
                const rgbColors =
                  colorBar.style.background.match(/\d{1,3}(?=[,|)])/g);

                this.#setSelectedColorTo(this.#convertRgbToHex(rgbColors));
              }
            });
          });
        }

        get savedColors() {
          return /*#loadColorsFromCache()*/;
        }

        #updateSavedColorOf(colorBar) {
          const currentlySelectedColor =
            this.#selectedColor.colorNameDisplay.textContent;
          const currentlySavedColors = this.#savedColors.values();

          this.#savedColors.set(colorBar, currentlySelectedColor);
          colorBar.style.background = currentlySelectedColor;

          localStorage.setItem(
            'cached-colors',
            JSON.stringify(currentlySavedColors),
          );
        }
      }

      const widgetDOM = {
        container: document.querySelector('.color-widget'),
        colorPicker: document.querySelector('.color-widget__picker'),
        selectedColor: {
          name: document.querySelector('.selected-colors__color-name'),
          colorBar: document.querySelector('.selected-colors__color'),
        },
        savedColors: {
          modeSwitch: document.querySelector('.mode-switch'),
          colorBars: document.querySelectorAll('.saved-colors__color'),
        },
      };

      const colorWidget = new ColorWidget(widgetDOM);
    </script>
  </body>

</html>