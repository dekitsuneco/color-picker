<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Picker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/colorjoe@4.1.1/css/colorjoe.min.css">
    <link rel="stylesheet" href="./src/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/colorjoe@4.1.1/dist/colorjoe.min.js"></script>
    <!--<script type="module" src="./src/js/main.js"></script>-->
  </head>

  <body>
    <div class="wrapper">
      <main class="main">
        <div class="color-widget">
          <div class="color-widget__picker"></div>

          <div class="color-widget__info info">
            <div class="info__selected-colors selected-colors">
              <div class="selected-colors__title">
                Selected Color
              </div>
              <div class="selected-colors__color-name">
                #ffffff
              </div>
              <div class="selected-colors__color"></div>
            </div>
            <div class="info__saved-colors saved-colors">
              <div class="saved-colors__title">
                <span class="mode-switch">
                  ðŸ”º
                </span>
                Saved Colors
              </div>
              <ul class="saved-colors__colors-list">
                <li data-key="0" class="saved-colors__color"></li>
                <li data-key="1" class="saved-colors__color"></li>
                <li data-key="2" class="saved-colors__color"></li>
                <li data-key="3" class="saved-colors__color"></li>
                <li data-key="4" class="saved-colors__color"></li>
              </ul>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      /**
       * @todo Change unclear refs to more appropriate ones
       * @todo Split code to small pure functions (methods)
       * @todo Rewrite class more compactly
       * @todo Add accesors for fileds related with colors instead of methods
       * @todo Style switcher to look nice
       * @todo Fix html and clean up CSS
       * @todo Add types to code
       * @todo Add background image from Build folder of my phone
       * @todo Add blurry-loading
       * @todo Push to GitHub
      */

      class ColorWidget {
        constructor(widgetElement) {
          // 1. Class state:
          this.isUpdatingMode = false;

          this.modeSwitch = widgetElement.savedColors.modeSwitch;
          this.selectedColor = {
            colorNameDisplay: widgetElement.selectedColor.name,
            colorBar: widgetElement.selectedColor.colorBar,
            lastPicked: '#3aebca',
          };
          this.savedColors = new Map();
          this.colorPicker = colorjoe.rgb(widgetElement.colorPicker);

          // 2. Init:
          this.setSelectedColor('#3aebca');
          this.setSavedColors(widgetElement.savedColors.colorBars);
          this.colorPicker.show();

          // 3. Event listeners:
          this.modeSwitch.addEventListener('click', () => {
            const icon = this.isUpdatingMode ? 'ðŸ”º' : 'ðŸ”»';

            this.isUpdatingMode = !this.isUpdatingMode;
            this.modeSwitch.textContent = icon;
          });
          this.selectedColor.colorBar.addEventListener('click', () => this.setSelectedColor(this.selectedColor.lastPicked));
          this.colorPicker.on('change', colorData => {
            const colorInHex = colorData.hex();

            this.selectedColor.lastPicked = colorInHex;
            this.setSelectedColor(colorInHex);
          });
        }

        componentToHex(color) {
          const colorInHex = Number(color).toString(16);
          
          return colorInHex.length === 1 ? '0' + colorInHex : colorInHex;
        }

        rgbToHex([r, g, b]) {
          return "#" + this.componentToHex(r) + this.componentToHex(g) + this.componentToHex(b);
        }

        // Selected Color:
        setSelectedColor(color) {
          this.selectedColor.colorNameDisplay.textContent = color;
          this.selectedColor.colorBar.style.background = color;
        }

        // Saved Color:
        loadColorsFromCache() {
          const saved = JSON.parse(localStorage.getItem('cached-colors') || '[]');

          return new Array(5).fill('#3aebca').map((defaultColor, key) => saved[key] || defaultColor);
        }

        setSavedColors(colorBars) {
          const currentlySavedColors = this.loadColorsFromCache();

          colorBars.forEach((colorBar, key) => {
            this.savedColors.set(colorBar, currentlySavedColors[key]);

            colorBar.style.background = currentlySavedColors[key];

            colorBar.addEventListener('mouseover', () => {
              if (!this.isUpdatingMode) {
                const rgbColors = colorBar.style.background.match(/\d{1,3}(?=[,|)])/g);

                this.setSelectedColor(this.rgbToHex(rgbColors));
              }
            });

            colorBar.addEventListener('click', () => {
              if (this.isUpdatingMode) {
                this.updateSavedColor(colorBar, key);
              }
            });
          });
        }

        getSavedColors() {
          return /*loadColorsFromCache()*/;
        }

        updateSavedColor(colorBar) {
          const currentlySelectedColor = this.selectedColor.colorNameDisplay.textContent;
          const currentlySavedColors = this.savedColors.values();

          this.savedColors.set(colorBar, currentlySelectedColor);
          colorBar.style.background = currentlySelectedColor;

          localStorage.setItem('cached-colors', JSON.stringify(currentlySavedColors));
        }
      }


      const widgetDOM = {
        container: document.querySelector('.color-widget'),
        colorPicker: document.querySelector('.color-widget__picker'),
        selectedColor: {
          name: document.querySelector('.selected-colors__color-name'),
          colorBar: document.querySelector('.selected-colors__color'),
        },
        savedColors: {
          modeSwitch: document.querySelector('.mode-switch'),
          colorBars: document.querySelectorAll('.saved-colors__color'),
        },
      };

      const colorWidget = new ColorWidget(widgetDOM);
    </script>
  </body>

</html>